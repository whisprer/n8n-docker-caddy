# ==========================================================
# Primary site: WordPress at /curiously-caffeinated
# ==========================================================
blairboulevard.online {
	*.whispr.dev, whispr.dev {
		encode gzip
		root * /var/www/html
		php_fastcgi unix//run/php/php8.2-fpm.sock
		file_server

		@rest_api path /curiously-caffeinated/wp-json/*
		reverse_proxy wordpress:80 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
			header_up Authorization {>Authorization}
		}

		# Route /curiously-caffeinated to WordPress container
		handle_path /curiously-caffeinated/* {
			reverse_proxy wordpress:80 {
				header_up Host {host}
				header_up X-Real-IP {remote_host}
				header_up X-Forwarded-For {remote_host}
				header_up X-Forwarded-Proto {scheme}
				header_up Authorization {>Authorization}
			}
		}

		# General WordPress security headers
		header {
			Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
			X-Content-Type-Options "nosniff"
			X-Frame-Options "SAMEORIGIN"
			Referrer-Policy "no-referrer-when-downgrade"
			Permissions-Policy "geolocation=(), microphone=(), camera=()"
		}

		log {
			output stdout
			format console
		}
	}

	# ==========================================================
	# n8n subdomain
	# ==========================================================
	n8n.blairboulevard.online {
		encode gzip zstd
		reverse_proxy n8n:5678 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}

		log {
			output stdout
			format console
		}

		header {
			Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
			X-Content-Type-Options "nosniff"
			Referrer-Policy "same-origin"
		}
	}

	# ==========================================================
	# Optional redirect www â†’ root
	# ==========================================================
	www.blairboulevard.online {
		redir https://blairboulevard.online{uri} permanent
	}
